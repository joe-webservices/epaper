<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ePaper | Home</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/assets/css/styles.css" />
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-storage-compat.js"></script>
  </head>

  <body>
    <!-- Logo -->
    <div class="logo">
      <img src="/assets/images/logo.png" alt="ePaper Logo" />
    </div>

    <!-- Headline -->
    <div class="tagline">Empower your <span>mornings.</span></div>
    <div class="subtag">Read your favourite newspaper, the digital way.</div>

    <!-- Filters -->
    <div class="container filter-controls">
      <div class="row justify-content-center g-3">
        <div class="col-md-4">
          <input
            type="text"
            id="searchInput"
            class="form-control"
            placeholder="Search newspaper name..."
          />
        </div>
        <div class="col-md-3">
          <select id="monthFilter" class="form-select">
            <option value="">All Months</option>
          </select>
        </div>
        <div class="col-md-2">
          <button id="clearBtn" class="btn btn-outline-secondary w-100">
            Clear Search
          </button>
        </div>
      </div>
    </div>

    <!-- Editions -->
    <div class="container">
      <div id="editions-row" class="row g-4 text-center">
        <!-- Cards here -->
      </div>
      <div id="loading" class="text-center my-5">Loading editions...</div>
      <div
        id="error"
        class="text-center text-danger my-5"
        style="display: none"
      ></div>
    </div>

    <!-- Footer -->
    <footer>
      <small>&copy; 2025 ePaper Platform. All rights reserved.</small>
    </footer>

    <script>
      // Fetch Firebase config from external JSON
      fetch("/firebase-config.json")
        .then((res) => {
          if (!res.ok) throw new Error("Failed to load Firebase config");
          return res.json();
        })
        .then((firebaseConfig) => {
          firebase.initializeApp(firebaseConfig);
          const db = firebase.database();

          // Initialize your app here
          startApp(db);
        })
        .catch((error) => {
          document.getElementById("loading").style.display = "none";
          const errorEl = document.getElementById("error");
          errorEl.style.display = "block";
          errorEl.textContent =
            "Failed to initialize Firebase: " + error.message;
          console.error(error);
        });

      function startApp(db) {
        const editionsRow = document.getElementById("editions-row");
        const loadingEl = document.getElementById("loading");
        const errorEl = document.getElementById("error");
        const searchInput = document.getElementById("searchInput");
        const monthFilter = document.getElementById("monthFilter");
        const clearBtn = document.getElementById("clearBtn");

        let allEditions = [];

        function formatDate(dateStr) {
          const d = new Date(dateStr);
          return d.toLocaleDateString("en-US", {
            year: "numeric",
            month: "long",
            day: "numeric",
          });
        }

        function extractDriveFileId(urlOrId) {
          const match = urlOrId.match(/\/d\/([a-zA-Z0-9_-]+)/);
          return match
            ? match[1]
            : /^[a-zA-Z0-9_-]+$/.test(urlOrId)
            ? urlOrId
            : null;
        }

        function renderEditions(data) {
          editionsRow.innerHTML = "";
          if (data.length === 0) {
            editionsRow.innerHTML = `<p class="text-muted">No results found.</p>`;
            return;
          }

          data.forEach((item) => {
            const col = document.createElement("div");
            col.className = "col-sm-6 col-md-4 col-lg-3";

            col.innerHTML = `
              <div class="edition-card h-100">
                <img src="${item.imgSrc}" alt="${
              item.paperName
            }" class="edition-img" />
                <div class="edition-title">${item.paperName.toUpperCase()}</div>
                <div class="edition-date">${formatDate(item.date)}</div>
                <a href="${
                  item.readLink
                }" class="read-link">Read Now &raquo;</a>
              </div>
            `;

            editionsRow.appendChild(col);
          });
        }

        function applyFilters() {
          const term = searchInput.value.toLowerCase();
          const selectedMonth = monthFilter.value;

          const filtered = allEditions.filter((edition) => {
            const matchesName = edition.paperName.toLowerCase().includes(term);
            const matchesMonth =
              !selectedMonth || edition.date.startsWith(selectedMonth);
            return matchesName && matchesMonth;
          });

          renderEditions(filtered);
        }

        function populateMonthDropdown(dates) {
          const months = Array.from(
            new Set(
              dates.map((d) => {
                const date = new Date(d);
                return `${date.getFullYear()}-${String(
                  date.getMonth() + 1
                ).padStart(2, "0")}`;
              })
            )
          )
            .sort()
            .reverse();

          months.forEach((m) => {
            const option = document.createElement("option");
            const [year, month] = m.split("-");
            option.value = m;
            option.textContent = `${new Date(m + "-01").toLocaleString(
              "en-US",
              {
                month: "long",
              }
            )} ${year}`;
            monthFilter.appendChild(option);
          });
        }

        function fetchEditions() {
          db.ref("editions")
            .once("value")
            .then((snapshot) => {
              loadingEl.style.display = "none";

              if (!snapshot.exists()) {
                editionsRow.innerHTML = "<p>No editions found.</p>";
                return;
              }

              const data = snapshot.val();
              allEditions = [];
              const dateList = [];

              for (const paperName in data) {
                const editionsByDate = data[paperName];
                const dates = Object.keys(editionsByDate);
                const latestDate = dates.sort().reverse()[0];
                const edition = editionsByDate[latestDate];
                dateList.push(latestDate);

                let imgSrc = edition.thumbUrl || "";

                if (!imgSrc) {
                  switch (paperName.toLowerCase()) {
                    case "toi":
                      imgSrc =
                        "https://epaper.timesgroup.com//TimesOfIndia/TimesOfIndia/2023/12/25/TOIBG/1_001/1_01/1_01_001.jpg";
                      break;
                    case "et":
                      imgSrc = "https://etimg.etb2bimg.com/photo/87369819.cms";
                      break;
                    case "mt":
                      imgSrc =
                        "https://maharashtratimes.com/thumb/10010940/maharashtra-times-logo.jpg";
                      break;
                    case "mirror":
                      imgSrc =
                        "https://images.indianexpress.com/2020/08/mirror.jpg";
                      break;
                    default:
                      imgSrc = "/img/logo.png";
                  }
                }

                const fileId = extractDriveFileId(edition.driveLink);
                const readLink = fileId
                  ? `viewer.html?fileId=${fileId}`
                  : edition.driveLink;

                allEditions.push({
                  paperName,
                  imgSrc,
                  date: latestDate,
                  readLink,
                });
              }

              populateMonthDropdown(dateList);
              renderEditions(allEditions);
            })
            .catch((error) => {
              loadingEl.style.display = "none";
              errorEl.style.display = "block";
              errorEl.textContent = "Failed to load editions: " + error.message;
            });
        }

        // Event Listeners
        searchInput.addEventListener("input", applyFilters);
        monthFilter.addEventListener("change", applyFilters);
        clearBtn.addEventListener("click", () => {
          searchInput.value = "";
          monthFilter.value = "";
          renderEditions(allEditions);
        });

        fetchEditions();
      }
    </script>
  </body>
</html>
