<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ePaper | Home</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background: #f8f9fa
          url("https://www.transparenttextures.com/patterns/paper-fibers.png");
        background-size: cover;
      }

      .logo {
        text-align: center;
        padding: 40px 0 20px;
      }

      .logo img {
        max-height: 80px;
      }

      .tagline {
        text-align: center;
        font-size: 2rem;
        font-weight: 700;
        color: #1f2937;
      }

      .tagline span {
        color: #d97706;
      }

      .subtag {
        text-align: center;
        font-size: 1rem;
        color: #6b7280;
        margin-bottom: 40px;
      }

      .edition-title {
        font-size: 1.1rem;
        font-weight: 700;
        margin-top: 15px;
        color: #111827;
      }

      .read-link {
        display: block;
        margin-top: 5px;
        color: #2563eb;
        text-decoration: none;
        font-weight: 500;
      }

      .read-link:hover {
        text-decoration: underline;
      }

      .edition-img {
        max-width: 100%;
        height: 180px;
        object-fit: cover;
        border-radius: 6px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
      }

      .edition-img:hover {
        transform: scale(1.03);
      }

      footer {
        margin-top: 60px;
        padding: 20px 0;
        background: #f1f1f1;
        text-align: center;
        color: #6b7280;
      }
    </style>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-storage-compat.js"></script>
  </head>
  <body>
    <!-- Logo -->
    <div class="logo">
      <img src="/assets/images/logo.png" alt="ePaper Logo" />
    </div>

    <!-- Headline -->
    <div class="tagline">Empower your <span>mornings.</span></div>
    <div class="subtag">Read your favourite newspaper, the digital way.</div>

    <!-- Editions -->
    <div class="container">
      <div id="editions-row" class="row text-center g-5">
        <!-- Dynamic editions will be inserted here -->
      </div>
      <div id="loading" class="text-center my-5">Loading editions...</div>
      <div
        id="error"
        class="text-center text-danger my-5"
        style="display: none"
      ></div>
    </div>

    <!-- Footer -->
    <footer>
      <small>&copy; 2025 ePaper Platform. All rights reserved.</small>
    </footer>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyDSTtPFBQa9K1830kFtWIWrbsgdWbQ41s4",
        authDomain: "project-404aa.firebaseapp.com",
        projectId: "project-404aa",
        storageBucket: "project-404aa.firebasestorage.app",
        messagingSenderId: "564465678821",
        appId: "1:564465678821:web:92dc6a490320560ca9570c",
        measurementId: "G-T8KQ8J7D5N",
        databaseURL:
          "https://project-404aa-default-rtdb.asia-southeast1.firebasedatabase.app",
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      const editionsRow = document.getElementById("editions-row");
      const loadingEl = document.getElementById("loading");
      const errorEl = document.getElementById("error");

      // Helper: format date string YYYY-MM-DD to readable form
      function formatDate(dateStr) {
        const d = new Date(dateStr);
        if (isNaN(d)) return dateStr; // fallback if invalid
        return d.toLocaleDateString("en-US", {
          year: "numeric",
          month: "long",
          day: "numeric",
        });
      }

      // Extract Google Drive File ID from a full drive link or just return id if already id
      function extractDriveFileId(urlOrId) {
        const regex = /\/d\/([a-zA-Z0-9_-]+)/;
        const match = urlOrId.match(regex);
        if (match && match[1]) return match[1];

        if (/^[a-zA-Z0-9_-]+$/.test(urlOrId)) return urlOrId;

        return null;
      }

      function fetchEditions() {
        db.ref("editions")
          .once("value")
          .then((snapshot) => {
            loadingEl.style.display = "none";

            if (!snapshot.exists()) {
              editionsRow.innerHTML = "<p>No editions found.</p>";
              return;
            }

            const editionsData = snapshot.val();
            editionsRow.innerHTML = ""; // Clear container

            // editionsData structure: { paperName: { date: {driveLink, thumb} } }
            // Show latest date edition for each paper
            for (const paperName in editionsData) {
              if (Object.hasOwnProperty.call(editionsData, paperName)) {
                const editionsByDate = editionsData[paperName];
                const dates = Object.keys(editionsByDate);
                const latestDate = dates.sort().reverse()[0];
                const edition = editionsByDate[latestDate];

                const colDiv = document.createElement("div");
                colDiv.className = "col-md-3 col-sm-6";

                let imgSrc = edition.thumb || "";

                if (!imgSrc) {
                  switch (paperName.toLowerCase()) {
                    case "toi":
                      imgSrc =
                        "https://epaper.timesgroup.com//TimesOfIndia/TimesOfIndia/2023/12/25/TOIBG/1_001/1_01/1_01_001.jpg";
                      break;
                    case "et":
                      imgSrc = "https://etimg.etb2bimg.com/photo/87369819.cms";
                      break;
                    case "mt":
                      imgSrc =
                        "https://maharashtratimes.com/thumb/10010940/maharashtra-times-logo.jpg";
                      break;
                    case "mirror":
                      imgSrc =
                        "https://images.indianexpress.com/2020/08/mirror.jpg";
                      break;
                    default:
                      imgSrc = "/img/logo.png"; // fallback
                  }
                }

                const formattedDate = formatDate(latestDate);

                const fileId = extractDriveFileId(edition.driveLink);

                const readLink = fileId
                  ? `viewer.html?fileId=${fileId}`
                  : edition.driveLink;

                colDiv.innerHTML = `
                  <img src="${imgSrc}" alt="${paperName}" class="edition-img" />
                  <div class="edition-title">${paperName.toUpperCase()}</div>
                  <small class="text-muted">Edition: ${formattedDate}</small>
                  <a href="${readLink}" target="_blank" class="read-link">Read Now Â»</a>
                `;

                editionsRow.appendChild(colDiv);
              }
            }
          })
          .catch((error) => {
            loadingEl.style.display = "none";
            errorEl.style.display = "block";
            errorEl.textContent = "Failed to load editions: " + error.message;
          });
      }

      // Fetch editions on page load
      fetchEditions();
    </script>
  </body>
</html>
